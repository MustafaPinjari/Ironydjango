{% extends 'dashboard/base_dashboard.html' %}
{% load humanize %}

{% block dashboard_content %}
<div class="dashboard-header d-flex justify-content-between align-items-center">
    <div>
        <h2>Order #{{ order.id }}</h2>
        <p class="text-muted mb-0">
            Placed on {{ order.created_at|date:"F d, Y" }}
            {% if order.updated_at != order.created_at %}
                • Last updated {{ order.updated_at|timesince }} ago
            {% endif %}
        </p>
    </div>
    <div class="btn-group">
        {% if user.is_admin or user.is_press %}
        <a href="{% url 'dashboard:update_order_status' order.pk %}" class="btn btn-primary">
            <i class="fas fa-edit me-1"></i> Update Status
        </a>
        {% endif %}
        <a href="{% url 'orders:detail' order.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-print me-1"></i> Print
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Order Items -->
        <div class="dashboard-card mb-4">
            <div class="card-header">
                <i class="fas fa-box-open me-2"></i>Order Items
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Item</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                            <tr>
                                <td>
                                    <strong>{{ item.cloth_type.name }}</strong>
                                    {% if item.special_instructions %}
                                    <div class="text-muted small">{{ item.special_instructions }}</div>
                                    {% endif %}
                                </td>
                                <td>₹{{ item.unit_price|intcomma }}</td>
                                <td>{{ item.quantity }}</td>
                                <td>₹{{ item.total_price|intcomma }}</td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Order Totals -->
                            <tr>
                                <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                <td><strong>₹{{ order.total_amount|intcomma }}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Tax ({{ order.tax_percentage }}%):</strong></td>
                                <td>₹{{ order.tax_amount|intcomma|default:"0" }}</td>
                            </tr>
                            <tr class="table-active">
                                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                <td><strong>₹{{ order.total_amount_with_tax|intcomma }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Order Notes -->
        {% if order.notes %}
        <div class="dashboard-card mb-4">
            <div class="card-header">
                <i class="fas fa-sticky-note me-2"></i>Special Instructions
            </div>
            <div class="card-body">
                <p class="mb-0">{{ order.notes|linebreaksbr }}</p>
            </div>
        </div>
        {% endif %}
        
        <!-- Status History -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-history me-2"></i>Status History
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    {% for history in order.statushistory_set.all %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ history.get_status_display }}</h6>
                            <small class="text-muted">{{ history.created_at|timesince }} ago</small>
                        </div>
                        {% if history.notes %}
                        <p class="mb-1">{{ history.notes }}</p>
                        {% endif %}
                        <small class="text-muted">
                            {% if history.changed_by %}
                                Updated by {{ history.changed_by.get_full_name|default:history.changed_by.email }}
                            {% else %}
                                System generated
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                    {% if not order.statushistory_set.exists %}
                    <div class="text-center p-4">
                        <i class="fas fa-info-circle me-2"></i>
                        No status history available
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Order Summary -->
        <div class="dashboard-card mb-4">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Order Summary
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Order Status</h6>
                    <div class="d-flex align-items-center">
                        <span class="status-badge status-{{ order.status|lower|slugify }} me-2">
                            {{ order.get_status_display }}
                        </span>
                        {% if order.is_delivered %}
                        <span class="text-success">
                            <i class="fas fa-check-circle"></i> Delivered
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Order Number</h6>
                    <p class="mb-0">#{{ order.id }}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Order Date</h6>
                    <p class="mb-0">{{ order.created_at|date:"F d, Y \a\t h:i A" }}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Service Type</h6>
                    <p class="mb-0">{{ order.get_service_type_display }}</p>
                </div>
                
                {% if user.is_admin or user.is_press %}
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Assigned To</h6>
                    {% if order.press_person %}
                        <p class="mb-0">{{ order.press_person.get_full_name|default:order.press_person.email }}</p>
                    {% else %}
                        <p class="mb-0 text-muted">Unassigned</p>
                        {% if user.is_admin %}
                        <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#assignModal">
                            <i class="fas fa-user-plus me-1"></i> Assign Staff
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
                {% endif %}
                
                {% if order.delivery_partner %}
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Delivery Partner</h6>
                    <p class="mb-0">
                        {{ order.delivery_partner.get_full_name|default:order.delivery_partner.email }}
                        {% if order.delivery_partner.phone_number %}
                            <br><small class="text-muted">{{ order.delivery_partner.phone_number }}</small>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                {% if order.pickup_date %}
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Scheduled Pickup</h6>
                    <p class="mb-0">
                        {{ order.pickup_date|date:"F d, Y \a\t h:i A" }}
                        {% if order.is_pickup_overdue %}
                            <span class="badge bg-danger ms-2">Overdue</span>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                {% if order.delivery_date %}
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted small mb-1">Scheduled Delivery</h6>
                    <p class="mb-0">
                        {{ order.delivery_date|date:"F d, Y \a\t h:i A" }}
                        {% if order.is_delivery_overdue %}
                            <span class="badge bg-danger ms-2">Overdue</span>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Customer Information -->
        <div class="dashboard-card mb-4">
            <div class="card-header">
                <i class="fas fa-user me-2"></i>Customer Information
            </div>
            <div class="card-body">
                <h6 class="mb-1">{{ order.customer.get_full_name|default:order.customer.email }}</h6>
                {% if order.customer.phone_number %}
                <p class="mb-1">
                    <i class="fas fa-phone-alt me-2"></i> {{ order.customer.phone_number }}
                </p>
                {% endif %}
                <p class="mb-1">
                    <i class="fas fa-envelope me-2"></i> {{ order.customer.email }}
                </p>
                
                <hr>
                
                <h6 class="text-uppercase text-muted small mb-2">Pickup Address</h6>
                <address class="mb-3">
                    {{ order.pickup_address|linebreaksbr }}
                </address>
                
                <h6 class="text-uppercase text-muted small mb-2">Delivery Address</h6>
                <address>
                    {{ order.delivery_address|linebreaksbr }}
                </address>
                
                {% if user.is_admin or user.is_press %}
                <div class="mt-3
                <a href="mailto:{{ order.customer.email }}" class="btn btn-sm btn-outline-primary w-100 mb-2">
                    <i class="fas fa-envelope me-1"></i> Email Customer
                </a>
                {% if order.customer.phone_number %}
                <a href="tel:{{ order.customer.phone_number }}" class="btn btn-sm btn-outline-success w-100">
                    <i class="fas fa-phone-alt me-1"></i> Call Customer
                </a>
                {% endif %}
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="card-header">
                <i class="fas fa-bolt me-2"></i>Quick Actions
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if user.is_admin or user.is_press %}
                        {% if order.status == 'PENDING' %}
                        <a href="{% url 'dashboard:update_order_status' order.pk %}" class="btn btn-success">
                            <i class="fas fa-check-circle me-1"></i> Confirm Order
                        </a>
                        {% endif %}
                        
                        {% if order.status == 'CONFIRMED' %}
                        <a href="{% url 'dashboard:update_order_status' order.pk %}" class="btn btn-primary">
                            <i class="fas fa-play-circle me-1"></i> Start Processing
                        </a>
                        {% endif %}
                        
                        {% if order.status == 'IN_PROGRESS' %}
                        <a href="{% url 'dashboard:update_order_status' order.pk %}" class="btn btn-warning text-white">
                            <i class="fas fa-tshirt me-1"></i> Mark as Ready for Pickup
                        </a>
                        {% endif %}
                        
                        {% if order.status == 'READY_FOR_PICKUP' and user.is_admin %}
                        <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#assignDeliveryModal">
                            <i class="fas fa-truck me-1"></i> Assign for Delivery
                        </button>
                        {% endif %}
                        
                        {% if order.status != 'CANCELLED' and order.status != 'REJECTED' and order.status != 'DELIVERED' %}
                        <a href="{% url 'dashboard:update_order_status' order.pk %}" class="btn btn-danger">
                            <i class="fas fa-times-circle me-1"></i> Cancel Order
                        </a>
                        {% endif %}
                        
                        <div class="dropdown-divider"></div>
                        
                        <a href="{% url 'orders:update' order.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-edit me-1"></i> Edit Order
                        </a>
                        
                        {% if user.is_admin %}
                        <a href="{% url 'orders:delete' order.pk %}" class="btn btn-outline-danger"
                           onclick="return confirm('Are you sure you want to delete this order? This action cannot be undone.');">
                            <i class="fas fa-trash-alt me-1"></i> Delete Order
                        </a>
                        {% endif %}
                    {% else %}
                        {% if order.status == 'PENDING' %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i> Your order is being reviewed.
                        </div>
                        {% elif order.status == 'IN_PROGRESS' %}
                        <div class="alert alert-primary">
                            <i class="fas fa-spinner fa-spin me-1"></i> Your order is being processed.
                        </div>
                        {% elif order.status == 'READY_FOR_PICKUP' %}
                        <div class="alert alert-warning">
                            <i class="fas fa-tshirt me-1"></i> Your order is ready for pickup!
                        </div>
                        {% elif order.status == 'DELIVERED' %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-1"></i> Your order has been delivered!
                        </div>
                        {% elif order.status == 'CANCELLED' or order.status == 'REJECTED' %}
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle me-1"></i> 
                            This order has been {{ order.get_status_display|lower }}.
                        </div>
                        {% endif %}
                        
                        {% if order.status != 'CANCELLED' and order.status != 'REJECTED' and order.status != 'DELIVERED' %}
                        <a href="#" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                            <i class="fas fa-times-circle me-1"></i> Request Cancellation
                        </a>
                        {% endif %}
                        
                        <a href="{% url 'orders:detail' order.pk %}" class="btn btn-outline-primary">
                            <i class="fas fa-print me-1"></i> Print Receipt
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Staff Modal -->
{% if user.is_admin %}
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Order to Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'orders:assign_staff' order.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="staffSelect" class="form-label">Select Staff Member</label>
                        <select class="form-select" id="staffSelect" name="staff_id" required>
                            <option value="">-- Select Staff --</option>
                            {% for staff in available_staff %}
                            <option value="{{ staff.id }}">
                                {{ staff.get_full_name|default:staff.email }} ({{ staff.get_role_display }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Assign Delivery Modal -->
{% if user.is_admin %}
<div class="modal fade" id="assignDeliveryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Delivery Partner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'orders:assign_delivery' order.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="deliverySelect" class="form-label">Select Delivery Partner</label>
                        <select class="form-select" id="deliverySelect" name="delivery_partner_id" required>
                            <option value="">-- Select Delivery Partner --</option>
                            {% for partner in delivery_partners %}
                            <option value="{{ partner.id }}" {% if order.delivery_partner_id == partner.id %}selected{% endif %}>
                                {{ partner.get_full_name|default:partner.email }}
                                {% if partner.phone_number %}({{ partner.phone_number }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deliveryDate" class="form-label">Scheduled Delivery Date</label>
                        <input type="datetime-local" class="form-control" id="deliveryDate" name="delivery_date" 
                               value="{{ order.delivery_date|date:'Y-m-d\TH:i' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign & Notify</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Order Cancellation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'orders:request_cancellation' order.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to request cancellation of this order?
                    </div>
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="cancellationReason" name="reason" rows="3" required
                                  placeholder="Please provide a reason for cancellation"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Auto-close alerts after 5 seconds
    window.setTimeout(function() {
        $(".alert").fadeTo(500, 0).slideUp(500, function(){
            $(this).remove(); 
        });
    }, 5000);
</script>
{% endblock %}
