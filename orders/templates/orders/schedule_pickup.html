{% extends 'orders/base_orders.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Schedule Pickup for Order #{{ order.order_number }}</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please schedule a pickup time for this order. The customer will be notified of the scheduled pickup.
                    </div>
                    
                    <form method="post" action="{% url 'orders:schedule_pickup' order.pk %}">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label for="pickupDate" class="form-label">Pickup Date</label>
                            <input type="date" class="form-control" id="pickupDate" name="pickup_date" required 
                                   min="{{ today|date:'Y-m-d' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="pickupTime" class="form-label">Pickup Time</label>
                            <input type="time" class="form-control" id="pickupTime" name="pickup_time" 
                                   min="09:00" max="18:00" value="10:00" required>
                            <small class="text-muted">Pickup hours: 9:00 AM - 6:00 PM</small>
                        </div>
                        
                        <div class="mb-4">
                            <label for="notes" class="form-label">Additional Notes (Optional)</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Any special instructions for the delivery partner..."></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'orders:press_dashboard' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calendar-check me-1"></i> Schedule Pickup
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set minimum time to current time if today's date is selected
    document.getElementById('pickupDate').addEventListener('change', function() {
        const today = new Date().toISOString().split('T')[0];
        const timeInput = document.getElementById('pickupTime');
        
        if (this.value === today) {
            // If today is selected, set minimum time to current time + 1 hour
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            timeInput.min = `${hours}:${minutes}`;
            
            // If current time is after 5 PM, disable time selection
            if (now.getHours() >= 17) {
                timeInput.disabled = true;
                timeInput.value = '';
                alert('Pickup time for today has passed. Please select a future date.');
            } else {
                timeInput.disabled = false;
                // Set default time to current time + 1 hour, or 9 AM if it's before 9 AM
                const defaultHour = Math.max(9, now.getHours() + 1);
                timeInput.value = `${defaultHour.toString().padStart(2, '0')}:00`;
            }
        } else {
            // For future dates, reset min time to 9 AM
            timeInput.min = '09:00';
            timeInput.disabled = false;
            timeInput.value = '10:00';
        }
    });
    
    // Initialize date picker with today's date
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const dateInput = document.getElementById('pickupDate');
        dateInput.min = today.toISOString().split('T')[0];
        
        // Set default date to today or next business day if after hours
        const hours = today.getHours();
        if (hours >= 17) {
            // If after 5 PM, default to next business day
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            // Skip weekends (0 = Sunday, 6 = Saturday)
            if (tomorrow.getDay() === 0) {
                tomorrow.setDate(tomorrow.getDate() + 1);
            } else if (tomorrow.getDay() === 6) {
                tomorrow.setDate(tomorrow.getDate() + 2);
            }
            dateInput.value = tomorrow.toISOString().split('T')[0];
        } else {
            // Default to today
            dateInput.value = today.toISOString().split('T')[0];
        }
        
        // Trigger change event to set appropriate time
        dateInput.dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}
